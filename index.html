<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Yearly Progress Widget</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Work+Sans:wght@300&display=swap');

  :root{
    --radius:14px;
    --pink:#ffe7f5;
    --green:#e7f8ee;
    --lavender:#f6e5fc;
    --blue:#daece1;
    --accent:#ff82a9;
    --muted:#9b9b9b;
  }

  body{
    margin:0;
    font-family:'Work Sans',sans-serif;
    display:flex;
    justify-content:center;
    background:transparent;
    color:#2b2b2b;
    -webkit-font-smoothing:antialiased;
  }

  .widget{
    width:340px;
    max-width:95vw;
    background:var(--pink);
    border-radius:var(--radius);
    padding:14px;
    box-shadow:0 8px 22px rgba(0,0,0,0.12);
    box-sizing:border-box;
    position:relative;
    overflow:visible;
    text-transform:lowercase;
  }

  .header{
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap:8px;
    margin-bottom:12px;
  }

  .title{
    font-size:16px;
    font-weight:300;
    margin:0;
  }

  .meta{
    font-size:12px;
    color:var(--muted);
    text-align:right;
  }

  .days-til{
    font-weight:600;
    color:#333;
    font-size:13px;
  }

  .top-row{
    display:flex;
    justify-content:space-between;
    align-items:center;
    gap:10px;
  }

  .bars-wrap{
    display:flex;
    gap:8px;
    align-items:end;
    justify-content:space-between;
    padding:12px 6px 6px 6px;
    height:220px;
  }

  .month-col{
    width:18px;
    display:flex;
    flex-direction:column;
    align-items:center;
    gap:6px;
    position:relative;
    cursor:default;
  }

  .bar-outer{
    width:100%;
    height:160px;
    background:rgba(255,255,255,0.35);
    border-radius:8px;
    display:flex;
    align-items:flex-end;
    overflow:hidden;
    box-shadow: inset 0 1px 0 rgba(255,255,255,0.25);
    transition:transform .12s;
  }

  .bar-outer:hover{ transform:scale(1.02); }

  .bar-fill{
  width:100%;
  background:var(--accent); /* replaced static gradient */
  height:0%;
  transition:height .5s ease, background .3s ease;
  display:flex;
  align-items:flex-end;
  justify-content:center;
  border-radius:6px;
}
  .meta {
  display:none !important;
}

  .month-label{
    font-size:10px;
    color:#333;
    writing-mode:vertical-rl;
    transform: rotate(180deg);
    letter-spacing:1px;
  }

  .month-number{
    font-size:11px;
    color:var(--muted);
  }

  /* tooltip */
  .tooltip{
    position:absolute;
    min-width:180px;
    max-width:260px;
    background: #fff0f8;
    border-radius:10px;
    padding:8px 10px;
    box-shadow:0 8px 20px rgba(0,0,0,0.12);
    font-size:12px;
    z-index:30;
    display:none;
    pointer-events:none;
    transform-origin:top left;
  }
  .mood-dot {
  width:12px;
  height:12px;
  border-radius:50%;
  display:inline-block;
  margin-right:6px;
}

  .tooltip .row{ display:flex; justify-content:space-between; gap:8px; margin:6px 0; }
  .tooltip strong{ font-weight:600; font-size:13px; }

  /* goals and modal */
  .controls{
    display:flex;
    gap:8px;
    margin-top:8px;
    align-items:center;
    justify-content:space-between;
  }

  .btn{
    background:var(--accent);
    color:white;
    border:none;
    padding:6px 10px;
    border-radius:10px;
    font-weight:600;
    cursor:pointer;
    font-size:13px;
  }

  .link-btn{
    background:transparent;
    border:1px solid rgba(0,0,0,0.06);
    padding:6px 8px;
    border-radius:10px;
    font-size:12px;
    cursor:pointer;
  }

  /* goals modal (inline inside widget) */
  .modal{
    position:absolute;
    left:50%;
    top:36px;
    transform:translateX(-50%);
    width:92%;
    max-height:260px;
    overflow:auto;
    background:rgba(255,255,255,0.98);
    border-radius:12px;
    padding:10px;
    box-shadow:0 10px 30px rgba(0,0,0,0.12);
    z-index:50;
    display:none;
  }

  .modal h3{ margin:6px 0 8px 0; font-size:13px; text-align:center; }
  .goal-input, .goal-add{
    display:flex; gap:8px; margin-bottom:8px;
  }
  .goal-input input{
    flex:1;
    padding:8px;
    border-radius:10px;
    border:1px solid rgba(0,0,0,0.06);
    outline:none;
  }
  .goal-list{ display:flex; flex-direction:column; gap:6px; margin-top:6px; }
  .goal-item{ background:var(--pink); padding:8px; border-radius:8px; display:flex; justify-content:space-between; align-items:center; gap:8px; }
  .goal-item small{ color:var(--muted); font-size:11px; }

  /* theme selector small copy of mood widget */
  .theme-selector{
    position:relative;
    cursor:pointer;
  }
  .current-theme-circle{
    width:18px; height:18px; border-radius:50%; border:1.5px solid #ccc; background:var(--pink);
  }
  .theme-options{
    position:absolute; top:30px; right:0; display:flex; gap:6px; background:white; padding:6px; border-radius:10px; box-shadow:0 8px 20px rgba(0,0,0,0.08); z-index:60;
  }
  .theme-options .theme-option-circle{ width:18px; height:18px; border-radius:50%; border:1px solid #ccc; cursor:pointer; }

  /* small footer text */
  .footer{
    font-size:11px; color:var(--muted);
    margin-top:8px;
    text-align:center;
  }

  /* responsive tweak */
  @media (max-width:420px){
    .widget{ width:92vw; padding:12px; }
    .bars-wrap{ height:180px; }
  }
</style>
</head>
<body>
  <div class="widget" id="year-widget">
    <div class="header">
      <div>
        <h2 class="title">yearly progress</h2>
        <div class="meta">vertical months • hover for mood + finance</div>
      </div>
      <div style="display:flex;gap:8px;align-items:center;">
        <div class="days-til" id="daysTil"></div>
        <div class="theme-selector" id="themeSelector" title="change theme">
          <div class="current-theme-circle" id="currentThemeCircle"></div>
        </div>
      </div>
    </div>

    <div class="top-row">
      <div style="font-size:12px;color:#333">months</div>
      <div style="font-size:12px;color:var(--muted)">yearly snapshot</div>
    </div>

    <div class="bars-wrap" id="barsWrap">
      <!-- month columns inserted by JS -->
    </div>

    <div class="controls">
      <button class="btn" id="goalsBtn">goals</button>
      <button class="link-btn" id="todayBtn">today</button>
      <button class="link-btn" id="refreshBtn">refresh</button>
    </div>

    <div class="footer" id="footerText"></div>

    <!-- tooltip -->
    <div class="tooltip" id="tooltip"></div>

    <!-- goals modal -->
    <div class="modal" id="goalsModal" aria-hidden="true">
      <h3>year goals</h3>
      <div class="goal-input">
        <input id="goalInput" placeholder="add a goal (short)"/>
        <button id="addGoalBtn" class="btn" style="padding:6px 10px;">add</button>
      </div>
      <div class="goal-list" id="goalList"></div>
      <div style="display:flex;gap:8px;margin-top:8px;">
        <button id="closeGoals" class="link-btn" style="flex:1">close</button>
        <button id="clearGoals" class="link-btn" style="flex:1">clear all</button>
      </div>
    </div>
  </div>

<script>
(function(){
  // config
  const monthNames = ['jan','feb','mar','apr','may','jun','jul','aug','sep','oct','nov','dec'];
  const widget = document.getElementById('year-widget');
  const barsWrap = document.getElementById('barsWrap');
  const daysTilEl = document.getElementById('daysTil');
  const tooltip = document.getElementById('tooltip');
  const footerText = document.getElementById('footerText');
  const todayBtn = document.getElementById('todayBtn');
  const refreshBtn = document.getElementById('refreshBtn');

  // theme selector
  const themeSelector = document.getElementById('themeSelector');
  const currentThemeCircle = document.getElementById('currentThemeCircle');
  const themeOptions = document.createElement('div');
  themeOptions.className = 'theme-options';
  const themeMap = {
    pink: {
    bg: '#ffe7f5',
    bar: '#ff66a3'   // hot pink
  },
  green: {
    bg: '#e7f8ee',
    bar: '#5f9c7a'   // muted dark sage
  },
  lavender: {
    bg: '#f6e5fc',
    bar: '#b37cd6'   // deep lavender
  },
  blue: {
    bg: '#daece1',
    bar: '#6ea8c9'   // dusty muted blue
  }
};
  Object.entries(themeMap).forEach(([k,c])=>{
    const d = document.createElement('div');
    d.className = 'theme-option-circle';
    d.style.background = c;
    d.dataset.theme = k;
    themeOptions.appendChild(d);
  });
  themeSelector.appendChild(themeOptions);
  themeOptions.style.display = 'none';

  // goals modal
  const goalsBtn = document.getElementById('goalsBtn');
  const goalsModal = document.getElementById('goalsModal');
  const goalInput = document.getElementById('goalInput');
  const addGoalBtn = document.getElementById('addGoalBtn');
  const goalList = document.getElementById('goalList');
  const closeGoals = document.getElementById('closeGoals');
  const clearGoals = document.getElementById('clearGoals');

  // helpers
  const today = new Date();
  const year = today.getFullYear();
  const startOfYear = new Date(year,0,1);
  const endOfYear = new Date(year+1,0,1);
  const daysLeft = Math.ceil((endOfYear - today)/(24*60*60*1000));
  daysTilEl.textContent = `${daysLeft} days til ${year+1}`;

  // read local data functions
  function readMoodLog(){
    try { return JSON.parse(localStorage.getItem('mood-log')||'{}'); }
    catch(e){ return {}; }
  }
  function readFinanceArchive(){
    try { return JSON.parse(localStorage.getItem('financeArchive')||'{}'); }
    catch(e){ return {}; }
  }
  function readFinanceEntries(){
    try { return JSON.parse(localStorage.getItem('financeEntries')||'[]'); }
    catch(e){ return []; }
  }

  // mood label -> score for averaging
  const moodScore = {
    good:4, loved:5, rough:1, calm:4, social:4, hectic:2, meh:3, awesome:5
  };

  // compute per-month stats
  function computeMonthStats(){
    const moodLog = readMoodLog(); // dateKey -> {color,label}
    const financeArchive = readFinanceArchive();
    const financeEntries = readFinanceEntries(); // current month entries
    const months = [];

    for(let m=0;m<12;m++){
      months.push({
        idx:m,
        name:monthNames[m],
        monthKey: `${year}-${String(m+1).padStart(2,'0')}`,
        daysInMonth: new Date(year, m+1, 0).getDate(),
        moodCount:0,
        moodSum:0,
        avgMood: null,
        income:0,
        expenses:0,
        completion:0 // will be days passed / daysInMonth
      });
    }

    // moodLog entries keyed by date, compute monthly averages
    Object.entries(moodLog).forEach(([dateKey, mood])=>{
      // dateKey like YYYY-MM-DD
      if(!dateKey.startsWith(String(year))) return;
      const [y,mm,dd] = dateKey.split('-');
      const mIdx = parseInt(mm,10)-1;
      if(mIdx<0||mIdx>11) return;
      const score = mood && mood.label && moodScore[mood.label] ? moodScore[mood.label] : null;
      if(score !== null){
        months[mIdx].moodSum += score;
        months[mIdx].moodCount += 1;
      }
    });

    // financeArchive (archived months)
    Object.entries(financeArchive).forEach(([monthKey,data])=>{
      if(!monthKey.startsWith(String(year))) return;
      const mIdx = parseInt(monthKey.split('-')[1],10)-1;
      if(isNaN(mIdx)||mIdx<0||mIdx>11) return;
      months[mIdx].income += (data.totalIncome||0);
      months[mIdx].expenses += (data.totalExpenses||0);
    });

    // current financeEntries (if any) could include dates; add them by month
    financeEntries.forEach(entry=>{
      if(!entry.date) return;
      if(!entry.date.startsWith(String(year))) return;
      const mIdx = new Date(entry.date).getMonth();
      if(entry.type === 'income') months[mIdx].income += entry.amount;
      else months[mIdx].expenses += entry.amount || 0;
    });

    // finalize averages and completion (how much of that month has passed)
    months.forEach((m,i)=>{
      if(m.moodCount>0) m.avgMood = (m.moodSum / m.moodCount);
      // completion: if month < current month => 100%, if > current month => 0, if current month => proportion days passed
      const now = new Date();
      if(i < now.getMonth()) m.completion = 100;
      else if(i > now.getMonth()) m.completion = 0;
      else {
        const passed = now.getDate();
        m.completion = Math.round((passed / m.daysInMonth) * 100);
      }
    });

    return months;
  }

  // create vertical bars
  function renderBars(){
    barsWrap.innerHTML = '';
    const months = computeMonthStats();

    months.forEach(m=>{
      const col = document.createElement('div');
      col.className = 'month-col';
      col.dataset.month = m.monthKey;

      const barOuter = document.createElement('div');
      barOuter.className = 'bar-outer';
      const barFill = document.createElement('div');
      barFill.className = 'bar-fill';
      barFill.style.height = `${m.completion}%`;
      barFill.dataset.month = m.monthKey;

      barOuter.appendChild(barFill);

      const monthLabel = document.createElement('div');
      monthLabel.className = 'month-label';
      monthLabel.textContent = m.name;

      // small month number under label
      const monthNum = document.createElement('div');
      monthNum.className = 'month-number';
      monthNum.textContent = m.idx+1;

      col.appendChild(barOuter);
      col.appendChild(monthLabel);
      col.appendChild(monthNum);

      // hover tooltip logic
      col.addEventListener('mouseenter', (e)=>{
        const rect = col.getBoundingClientRect();
        const monthsStats = computeMonthStats();
        const stat = monthsStats[m.idx];
        showTooltipForMonth(stat, rect);
      });
      col.addEventListener('mouseleave', hideTooltip);
      // click: jump to month (emulate linking to other widgets — open small panel)
      col.addEventListener('click',(e)=>{
        e.stopPropagation();
        const stat = computeMonthStats()[m.idx];
        showTooltipForMonth(stat, col.getBoundingClientRect(), true);
      });

      barsWrap.appendChild(col);
    });
  }

  // tooltip content
  function showTooltipForMonth(stat, rect, pinned=false){
    // build content
    const avgMood = stat.avgMood ? stat.avgMood.toFixed(2) : '—';
    const income = stat.income ? stat.income.toFixed(2) : '0.00';
    const expenses = stat.expenses ? stat.expenses.toFixed(2) : '0.00';
    const daysLeftInMonth = (new Date(year, stat.idx+1, 0).getDate()) - (new Date().getDate());
    const moreDays = stat.idx === new Date().getMonth() ? `${daysLeftInMonth} more days til next month` : '';
    let moodLabel = '—';
let moodColor = '#ccc';

if(stat.avgMood){
  const moodLog = readMoodLog();
  const entries = Object.values(moodLog).filter(m=>m && m.label);
  if(entries.length){
    // pick most common mood for the month
    const map = {};
    entries.forEach(m=>{ map[m.label] = (map[m.label]||0)+1; });
    const top = Object.entries(map).sort((a,b)=>b[1]-a[1])[0][0];
    moodLabel = top;
    moodColor = entries.find(m=>m.label===top).color;
  }
}

tooltip.innerHTML = `
  <div style="font-size:13px;font-weight:600;text-transform:capitalize">${stat.name} ${year}</div>

  <div class="row">
    <span>month completion</span><strong>${stat.completion}%</strong>
  </div>

  <div class="row">
    <span>avg mood</span>
    <strong>
      <span class="mood-dot" style="background:${moodColor}"></span>
      ${moodLabel}
    </strong>
  </div>

  <div class="row"><span>income</span><strong>$${income}</strong></div>
  <div class="row"><span>expenses</span><strong>$${expenses}</strong></div>

  <div style="font-size:11px;color:var(--muted)">${moreDays}</div>
`;
    // position tooltip near rect inside widget
    const wRect = widget.getBoundingClientRect();
    const left = Math.min(Math.max((rect.left - wRect.left) + rect.width + 8, 12), wRect.width - 12 - 220);
    const top = Math.max((rect.top - wRect.top) - 8, 8);
    tooltip.style.left = left + 'px';
    tooltip.style.top = top + 'px';
    tooltip.style.display = 'block';
    if(pinned){
      // pinned tooltip stays until click elsewhere
      tooltip.dataset.pinned = '1';
    } else {
      tooltip.dataset.pinned = '';
    }
  }
  function hideTooltip(){
    if(tooltip.dataset.pinned === '1') return;
    tooltip.style.display = 'none';
    tooltip.innerHTML = '';
  }

  // days til next year footer content
  function updateFooter(){
    const now = new Date();
    const startNextYear = new Date(now.getFullYear()+1,0,1);
    const days = Math.ceil((startNextYear - now)/(24*60*60*1000));
    footerText.textContent = `${days} days until ${now.getFullYear()+1} • tracked mood + finance connect`;
  }

  // goals CRUD using localStorage 'yearly-goals-<year>'
  const goalsKey = `yearly-goals-${year}`;
  function loadGoals(){
    const raw = localStorage.getItem(goalsKey);
    try {
      return raw ? JSON.parse(raw) : [];
    } catch(e){ return []; }
  }
  function saveGoals(list){
    localStorage.setItem(goalsKey, JSON.stringify(list));
  }
  function renderGoals(){
    const list = loadGoals();
    goalList.innerHTML = '';
    list.forEach((g, i)=>{
      const item = document.createElement('div');
      item.className = 'goal-item';
      item.innerHTML = `<div style="display:flex;flex-direction:column;align-items:flex-start"><strong style="font-size:13px">${g.text}</strong><small>${g.date}</small></div>
        <div style="display:flex;gap:6px;align-items:center">
          <button data-i="${i}" class="link-btn mark-done">done</button>
          <button data-i="${i}" class="link-btn remove-goal">remove</button>
        </div>`;
      goalList.appendChild(item);
    });
    // attach handlers
    goalList.querySelectorAll('.remove-goal').forEach(btn=>{
      btn.addEventListener('click', ()=> {
        const idx = parseInt(btn.dataset.i,10);
        const arr = loadGoals();
        arr.splice(idx,1);
        saveGoals(arr);
        renderGoals();
      });
    });
    goalList.querySelectorAll('.mark-done').forEach(btn=>{
      btn.addEventListener('click', ()=> {
        const idx = parseInt(btn.dataset.i,10);
        const arr = loadGoals();
        arr[idx].done = true;
        saveGoals(arr);
        renderGoals();
      });
    });
  }

  // wire goals modal
  goalsBtn.addEventListener('click', (e)=>{
    e.stopPropagation();
    goalsModal.style.display = goalsModal.style.display === 'block' ? 'none' : 'block';
    renderGoals();
  });
  addGoalBtn.addEventListener('click', ()=>{
    const txt = (goalInput.value||'').trim();
    if(!txt) return;
    const arr = loadGoals();
    arr.push({ text: txt, date: new Date().toISOString().split('T')[0], done:false });
    saveGoals(arr);
    goalInput.value = '';
    renderGoals();
  });
  clearGoals.addEventListener('click', ()=>{
    saveGoals([]);
    renderGoals();
  });
  closeGoals.addEventListener('click', ()=> goalsModal.style.display='none');

  // theme selector handlers
  themeSelector.addEventListener('click', (e)=>{
    e.stopPropagation();
    themeOptions.style.display = themeOptions.style.display === 'flex' ? 'none' : 'flex';
  });
  themeOptions.querySelectorAll('.theme-option-circle').forEach(el=>{
   el.addEventListener('click', (ev)=>{
  const color = ev.target.style.background;
  widget.style.background = color;
  currentThemeCircle.style.background = color;
  document.querySelectorAll('.bar-fill').forEach(b=>{
    b.style.background = color;
  });
  localStorage.setItem('year-widget-theme', color);
  themeOptions.style.display = 'none';
});
  });

  // restore theme
  const savedTheme = localStorage.getItem('year-widget-theme');
  if(savedTheme){
    widget.style.background = savedTheme;
    currentThemeCircle.style.background = savedTheme;
  } else {
    currentThemeCircle.style.background = themeMap && themeMap.pink || '#ffe7f5';
  }

  // today button - scroll hover to current month (simulate)
  todayBtn.addEventListener('click', ()=>{
    const idx = new Date().getMonth();
    const target = barsWrap.querySelector(`[data-month="${year}-${String(idx+1).padStart(2,'0')}"]`);
    if(target){
      const r = target.getBoundingClientRect();
      showTooltipForMonth(computeMonthStatsForSingle(idx), r);
    }
  });

  // refresh
  refreshBtn.addEventListener('click', ()=> { renderBars(); updateFooter(); });

  // computeMonthStatsForSingle - helper for today btn
  function computeMonthStatsForSingle(i){
    return computeMonthStats()[i];
  }

  // small wrapper to get month stats array (same as used above)
  function computeMonthStats(){
    // reuse logic from above computeMonthStats but local
    const moodLog = (()=>{ try{return JSON.parse(localStorage.getItem('mood-log')||'{}')}catch(e){return{}} })();
    const financeArchive = readFinanceArchive();
    const financeEntries = readFinanceEntries();
    const months = [];
    for(let m=0;m<12;m++){
      months.push({
        idx:m,
        name:monthNames[m],
        monthKey: `${year}-${String(m+1).padStart(2,'0')}`,
        daysInMonth: new Date(year,m+1,0).getDate(),
        moodCount:0,moodSum:0,avgMood:null,
        income:0,expenses:0,completion:0
      });
    }

    Object.entries(moodLog).forEach(([dateKey,mood])=>{
      if(!dateKey.startsWith(String(year))) return;
      const mm = parseInt(dateKey.split('-')[1],10)-1;
      if(mm>=0&&mm<12){
        const s = (mood && mood.label && (moodScore[mood.label] || 0)) || 0;
        if(s) { months[mm].moodSum += s; months[mm].moodCount += 1; }
      }
    });

    Object.entries(financeArchive).forEach(([monthKey,data])=>{
      if(!monthKey.startsWith(String(year))) return;
      const mIdx = parseInt(monthKey.split('-')[1],10)-1;
      if(mIdx>=0 && mIdx<12){
        months[mIdx].income += (data.totalIncome||0);
        months[mIdx].expenses += (data.totalExpenses||0);
      }
    });

    financeEntries.forEach(entry=>{
      if(!entry.date) return;
      if(!entry.date.startsWith(String(year))) return;
      const mIdx = new Date(entry.date).getMonth();
      if(entry.type==='income') months[mIdx].income += entry.amount || 0;
      else months[mIdx].expenses += entry.amount || 0;
    });

    months.forEach((m,i)=>{
      if(m.moodCount>0) m.avgMood = (m.moodSum / m.moodCount);
      const now = new Date();
      if(i < now.getMonth()) m.completion = 100;
      else if(i > now.getMonth()) m.completion = 0;
      else m.completion = Math.round((now.getDate() / m.daysInMonth) * 100);
    });
    return months;
  }

  // init
  renderBars();
  updateFooter();

  // close tooltip if click outside
  document.body.addEventListener('click', ()=> {
    tooltip.style.display='none';
    tooltip.dataset.pinned='';
    themeOptions.style.display='none';
    goalsModal.style.display='none';
  });

  // keep tooltip pinned until next click if user clicked a month (the code sets dataset.pinned)
  document.addEventListener('click', (e)=>{
    if(tooltip.dataset.pinned === '1' && !tooltip.contains(e.target)) {
      tooltip.style.display='none';
      tooltip.dataset.pinned='';
    }
  });

  // small utilities: recompute on storage change (if other widget updates)
  window.addEventListener('storage', (e)=>{
    if(['mood-log','financeArchive','financeEntries'].includes(e.key)){
      renderBars();
      updateFooter();
    }
  });

  // expose a manual refresh to be safe
  window.yearWidgetRefresh = ()=>{ renderBars(); updateFooter(); };

})();
</script>
</body>
</html>
